<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="DTL">
<meta name="dcterms.date" content="2026-02-15">

<title>CvH Proteomics — Normalization Pipeline</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CvH_normalization_files/libs/clipboard/clipboard.min.js"></script>
<script src="CvH_normalization_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="CvH_normalization_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="CvH_normalization_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="CvH_normalization_files/libs/quarto-html/popper.min.js"></script>
<script src="CvH_normalization_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CvH_normalization_files/libs/quarto-html/anchor.min.js"></script>
<link href="CvH_normalization_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CvH_normalization_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CvH_normalization_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CvH_normalization_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CvH_normalization_files/libs/bootstrap/bootstrap-82a8e0681529fff444bbc39736ff6b3a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-setup" id="toc-sec-setup" class="nav-link active" data-scroll-target="#sec-setup">0 — Setup</a></li>
  <li><a href="#sec-load" id="toc-sec-load" class="nav-link" data-scroll-target="#sec-load">1 — Load &amp; Validate Data</a></li>
  <li><a href="#sec-dalist" id="toc-sec-dalist" class="nav-link" data-scroll-target="#sec-dalist">2 — Assemble DAList</a></li>
  <li><a href="#sec-filtering" id="toc-sec-filtering" class="nav-link" data-scroll-target="#sec-filtering">3 — Quality Filtering</a></li>
  <li><a href="#sec-outliers" id="toc-sec-outliers" class="nav-link" data-scroll-target="#sec-outliers">4 — Outlier Detection (Tiered Approach)</a>
  <ul class="collapse">
  <li><a href="#detection-methods" id="toc-detection-methods" class="nav-link" data-scroll-target="#detection-methods">Detection methods</a></li>
  <li><a href="#tiered-removal-strategy" id="toc-tiered-removal-strategy" class="nav-link" data-scroll-target="#tiered-removal-strategy">Tiered removal strategy</a></li>
  <li><a href="#sample-removal" id="toc-sample-removal" class="nav-link" data-scroll-target="#sample-removal">Sample removal</a></li>
  </ul></li>
  <li><a href="#sec-normalization" id="toc-sec-normalization" class="nav-link" data-scroll-target="#sec-normalization">5 — Normalization</a></li>
  <li><a href="#sec-qc" id="toc-sec-qc" class="nav-link" data-scroll-target="#sec-qc">6 — Post-Normalization QC</a></li>
  <li><a href="#sec-export" id="toc-sec-export" class="nav-link" data-scroll-target="#sec-export">7 — Export</a></li>
  <li><a href="#sec-downstream" id="toc-sec-downstream" class="nav-link" data-scroll-target="#sec-downstream">8 — Downstream Preview</a></li>
  <li><a href="#sec-refs" id="toc-sec-refs" class="nav-link" data-scroll-target="#sec-refs">References</a></li>
  <li><a href="#sec-session" id="toc-sec-session" class="nav-link" data-scroll-target="#sec-session">Session Info</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CvH Proteomics — Normalization Pipeline</h1>
<p class="subtitle lead">Cancer Survivor (CR) vs.&nbsp;Healthy (PPS) Skeletal Muscle DIA-MS Proteomics</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>DTL </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 15, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="sec-setup" class="level1">
<h1>0 — Setup</h1>
<p>This document implements a normalization pipeline for the CvH DIA-MS proteomics dataset using the <code>proteoDA</code> package. The pipeline follows current best practices for label-free quantitative proteomics preprocessing, drawing on recommendations from Välikangas et al.&nbsp;(2018) and the <code>proteoDA</code> workflow.</p>
<p><strong>Study overview:</strong> Cancer survivors (CR) who completed 12 weeks of resistance training were compared with healthy age-matched controls (PPS). CR participants were randomized to creatine (CRE) or placebo (PLA) supplementation. Vastus lateralis biopsies were collected at baseline (T1) and post-training (T2) for CR participants, and at a single timepoint (T1) for healthy controls.</p>
<p>Load required packages and set up paths.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Package management</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"pacman"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  proteoDA,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  readxl, readr, dplyr, tidyr, stringr,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  ggplot2, patchwork, ggrepel, knitr, here</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Paths</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>base_dir   <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>()</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>input_dir  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_dir, <span class="st">"00_input"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>report_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_dir, <span class="st">"01_normalization"</span>, <span class="st">"b_reports"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>data_dir   <span class="ot">&lt;-</span> <span class="fu">file.path</span>(base_dir, <span class="st">"01_normalization"</span>, <span class="st">"c_data"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(report_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(data_dir,   <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Color palette — consistent across all CvH scripts</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>pal_group <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">CR_CRE =</span> <span class="st">"#2166AC"</span>, <span class="at">CR_PLA =</span> <span class="st">"#67A9CF"</span>, <span class="at">PPS =</span> <span class="st">"#B2182B"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>pal_group_time <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">CR_T1 =</span> <span class="st">"#92C5DE"</span>, <span class="at">CR_T2 =</span> <span class="st">"#2166AC"</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">H_T1  =</span> <span class="st">"#B2182B"</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>pal_supplement <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">CRE =</span> <span class="st">"#2166AC"</span>, <span class="at">PLA =</span> <span class="st">"#67A9CF"</span>, <span class="st">`</span><span class="at">NA</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"#999999"</span>)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>shape_tp <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">T1 =</span> <span class="dv">16</span>, <span class="at">T2 =</span> <span class="dv">17</span>)  <span class="co"># circle, triangle</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
</section>
<section id="sec-load" class="level1">
<h1>1 — Load &amp; Validate Data</h1>
<p>We begin by reading the raw DIA-MS intensity data and the sample metadata. The raw file contains protein-level intensities exported from the search engine, with annotation columns (UniProt ID, gene symbol, description) followed by one column per sample.</p>
<p>Separate annotation columns from sample intensities for the DAList structure. The annotation/intensity split is required because <code>proteoDA</code> stores them in different slots.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Raw intensity data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>raw <span class="ot">&lt;-</span> <span class="fu">read_excel</span>(<span class="fu">file.path</span>(input_dir, <span class="st">"CvH_raw.xlsx"</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate annotation from intensity</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>annot_cols <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"uniprot_id"</span>, <span class="st">"protein"</span>, <span class="st">"gene"</span>, <span class="st">"description"</span>, <span class="st">"n_seq"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>annotation <span class="ot">&lt;-</span> raw[, annot_cols]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>intensity  <span class="ot">&lt;-</span> raw[, <span class="fu">setdiff</span>(<span class="fu">names</span>(raw), annot_cols)]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Raw data: %d proteins x %d samples</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(raw), <span class="fu">ncol</span>(intensity)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Raw data: 3172 proteins x 41 samples</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Metadata</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(input_dir, <span class="st">"CvH_meta.csv"</span>), <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(metadata) <span class="ot">&lt;-</span> metadata<span class="sc">$</span>Col_ID</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Metadata: %d samples</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(metadata)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Metadata: 41 samples</code></pre>
</div>
</div>
<p>A mismatch between sample identifiers in the intensity matrix and metadata would silently corrupt everything downstream, so we halt immediately if the sets differ.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Critical check: sample columns must match metadata rows</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>data_samples <span class="ot">&lt;-</span> <span class="fu">colnames</span>(intensity)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>meta_samples <span class="ot">&lt;-</span> metadata<span class="sc">$</span>Col_ID</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Sample mismatch between data and metadata"</span> <span class="ot">=</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setequal</span>(data_samples, meta_samples)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Reorder intensity columns to match metadata row order</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>intensity <span class="ot">&lt;-</span> intensity[, meta_samples]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Validation passed: all"</span>, <span class="fu">length</span>(meta_samples), <span class="st">"samples aligned.</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Validation passed: all 41 samples aligned.</code></pre>
</div>
</div>
<p>Verify the expected experimental design before proceeding.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>metadata <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Group, Timepoint, Group_Time, Supplement) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Sample distribution across experimental groups"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Sample distribution across experimental groups</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Group</th>
<th style="text-align: left;">Timepoint</th>
<th style="text-align: left;">Group_Time</th>
<th style="text-align: left;">Supplement</th>
<th style="text-align: right;">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CR_CRE</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">CRE_T1</td>
<td style="text-align: left;">CRE</td>
<td style="text-align: right;">9</td>
</tr>
<tr class="even">
<td style="text-align: left;">CR_CRE</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">CRE_T2</td>
<td style="text-align: left;">CRE</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CR_PLA</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">PLA_T1</td>
<td style="text-align: left;">PLA</td>
<td style="text-align: right;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">CR_PLA</td>
<td style="text-align: left;">T2</td>
<td style="text-align: left;">PLA_T2</td>
<td style="text-align: left;">PLA</td>
<td style="text-align: right;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">PPS</td>
<td style="text-align: left;">T1</td>
<td style="text-align: left;">H_T1</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">10</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="sec-dalist" class="level1">
<h1>2 — Assemble DAList</h1>
<p>The <code>proteoDA</code> package uses a <code>DAList</code> to hold intensity data, protein annotation, and sample metadata together, ensuring consistent indexing throughout. Before assembly, we annotate proteins against the Human Protein Atlas (HPA) skeletal muscle gene list (Uhlen et al., 2015) to flag tissue-relevant proteins for the filtering step.</p>
<p>When multiple rows share the same UniProt accession (e.g., isoforms collapsed by the search engine), we retain the entry with the highest mean intensity to ensure a unique row key.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># HPA skeletal muscle annotation</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>hpa_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(input_dir, <span class="st">"HPA_skeletal_muscle_annotations.tsv"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="st">"HPA annotations file not found"</span> <span class="ot">=</span> <span class="fu">file.exists</span>(hpa_file))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>hpa_genes <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">read_tsv</span>(hpa_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>Gene)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>annotation <span class="ot">&lt;-</span> annotation <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">in_hpa_muscle =</span> gene <span class="sc">%in%</span> hpa_genes)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"HPA muscle genes: %d | Matched in dataset: %d / %d</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">length</span>(hpa_genes), <span class="fu">sum</span>(annotation<span class="sc">$</span>in_hpa_muscle), <span class="fu">nrow</span>(annotation)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>HPA muscle genes: 12887 | Matched in dataset: 2962 / 3172</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicate uniprot_ids</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>dup_ids <span class="ot">&lt;-</span> annotation<span class="sc">$</span>uniprot_id[<span class="fu">duplicated</span>(annotation<span class="sc">$</span>uniprot_id)]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(dup_ids) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Found %d duplicate uniprot_ids — deduplicating by highest mean intensity.</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>              <span class="fu">length</span>(dup_ids)))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate row means for deduplication</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  intensity_num <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">lapply</span>(intensity, as.numeric))</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  annotation<span class="sc">$</span>row_mean <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(intensity_num, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  keep_idx <span class="ot">&lt;-</span> annotation <span class="sc">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_idx =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(uniprot_id) <span class="sc">%&gt;%</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_max</span>(row_mean, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(row_idx)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  annotation <span class="ot">&lt;-</span> annotation[keep_idx, ]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  intensity  <span class="ot">&lt;-</span> intensity[keep_idx, ]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  annotation<span class="sc">$</span>row_mean <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"After deduplication: %d unique proteins</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(annotation)))</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No duplicate uniprot_ids found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>No duplicate uniprot_ids found.</code></pre>
</div>
</div>
<p>Bundle all three components so <code>proteoDA</code> maintains consistent alignment throughout (Herbrich et al., 2013).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert intensity to numeric matrix</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>intensity_mat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">lapply</span>(intensity, as.numeric))</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(intensity_mat) <span class="ot">&lt;-</span> annotation<span class="sc">$</span>uniprot_id</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Annotation df</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>annot_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(annotation)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annot_df) <span class="ot">&lt;-</span> annotation<span class="sc">$</span>uniprot_id</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Metadata df — rownames must match colnames of data</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>meta_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(metadata)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(meta_df) <span class="ot">&lt;-</span> metadata<span class="sc">$</span>Col_ID</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Assemble</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>dal <span class="ot">&lt;-</span> <span class="fu">DAList</span>(</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">data       =</span> intensity_mat,</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">annotation =</span> annot_df,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">metadata   =</span> meta_df</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"DAList assembled: %d proteins x %d samples</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(dal<span class="sc">$</span>data), <span class="fu">ncol</span>(dal<span class="sc">$</span>data)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>DAList assembled: 3172 proteins x 41 samples</code></pre>
</div>
</div>
</section>
<section id="sec-filtering" class="level1">
<h1>3 — Quality Filtering</h1>
<p>Protein filtering proceeds in two stages: (1) removal of proteins without evidence of skeletal muscle expression in the Human Protein Atlas (Uhlen et al., 2015), and (2) removal of proteins with excessive missing data. The HPA tissue-relevance filter is a simple process of elimination: if a protein has no record of expression in skeletal muscle, it is unlikely to be biologically meaningful in this context and is removed before statistical modeling.</p>
<p>For DIA-MS data, missing values predominantly arise from peptides below the detection limit (missing not at random, MNAR) rather than stochastic sampling (missing completely at random, MCAR) as is more common in DDA data (Lazar et al., 2016). Label-free proteomics datasets commonly exceed 50% missingness across the full matrix (O’Brien et al., 2018), making per-group proportion filters a practical necessity. Benchmarking by Arioli et al.&nbsp;(2021) using OptiMissP showed that a 50% threshold offered the best trade-off between coverage and data completeness for DIA-MS. McGurk et al.&nbsp;(2020) further demonstrated that missing values in DIA-MS carry biological signal, supporting retention at a moderate threshold. Dabke et al.&nbsp;(2021) compared 80%, 50%, and 30% NA filters and found that 50% retained the most proteins while enabling accurate downstream imputation. Kong et al.&nbsp;(2022) reviewed missingness handling broadly and recommended per-group proportion filters near 50% as a practical default, while Harris et al.&nbsp;(2023) showed that a 50% completeness threshold preserves differential expression detection accuracy across imputation methods. Following these recommendations, we apply a 50% completeness threshold per <code>Group_Time</code> condition, ensuring retained proteins have sufficient observations for reliable statistical inference while preserving condition-specific proteins.</p>
<p>DIA-MS search engines export zeros for peptides below the detection limit. These must be recoded as <code>NA</code> so downstream functions correctly distinguish absent from zero-abundance measurements.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Track protein counts through filtering</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>filter_log <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">step      =</span> <span class="fu">character</span>(),</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_before  =</span> <span class="fu">integer</span>(),</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_after   =</span> <span class="fu">integer</span>(),</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_removed =</span> <span class="fu">integer</span>()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>n_start <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dal<span class="sc">$</span>data)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert 0s to NA (DIA-MS exports may use 0 for below-detection-limit)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>dal <span class="ot">&lt;-</span> <span class="fu">zero_to_missing</span>(dal)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>n_zeros <span class="ot">&lt;-</span> n_start  <span class="co"># same number of proteins, but 0s are now NA</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Converted zeros to NA. Total proteins: %d</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">nrow</span>(dal<span class="sc">$</span>data)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Converted zeros to NA. Total proteins: 3172</code></pre>
</div>
</div>
<p>Proteins absent from the HPA skeletal muscle gene list are removed. This tissue-relevance filter ensures downstream analysis focuses on biologically plausible targets rather than environmental or processing artifacts.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>n_before <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dal<span class="sc">$</span>data)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>dal <span class="ot">&lt;-</span> <span class="fu">filter_proteins_by_annotation</span>(dal, in_hpa_muscle)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>n_after <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dal<span class="sc">$</span>data)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>filter_log <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(filter_log, <span class="fu">tibble</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="st">"HPA muscle tissue filter"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_before =</span> n_before, <span class="at">n_after =</span> n_after, <span class="at">n_removed =</span> n_before <span class="sc">-</span> n_after</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"HPA muscle filtering: %d -&gt; %d proteins (%d removed)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            n_before, n_after, n_before <span class="sc">-</span> n_after))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>HPA muscle filtering: 3172 -&gt; 2962 proteins (210 removed)</code></pre>
</div>
</div>
<p>Apply the 50% per-group completeness threshold. The per-group approach preserves condition-specific proteins that a global filter would discard (Webb-Robertson et al., 2015; Kong et al., 2022).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>n_before <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dal<span class="sc">$</span>data)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>dal <span class="ot">&lt;-</span> <span class="fu">filter_proteins_by_proportion</span>(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  dal,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_prop =</span> <span class="fl">0.50</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">grouping_column =</span> <span class="st">"Group_Time"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>n_after <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dal<span class="sc">$</span>data)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>filter_log <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(filter_log, <span class="fu">tibble</span>(</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">step =</span> <span class="st">"Missingness filter (50% per Group_Time)"</span>,</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_before =</span> n_before, <span class="at">n_after =</span> n_after, <span class="at">n_removed =</span> n_before <span class="sc">-</span> n_after</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Missingness filtering: %d -&gt; %d proteins (%d removed)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>            n_before, n_after, n_before <span class="sc">-</span> n_after))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Missingness filtering: 2962 -&gt; 1829 proteins (1133 removed)</code></pre>
</div>
</div>
<p>Record protein counts at each stage and write removed proteins with their removal reason (not in HPA muscle vs.&nbsp;missingness) for audit purposes.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the starting count</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>filter_log <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tibble</span>(<span class="at">step =</span> <span class="st">"Raw input"</span>, <span class="at">n_before =</span> <span class="cn">NA_integer_</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">n_after =</span> n_start, <span class="at">n_removed =</span> <span class="cn">NA_integer_</span>),</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  filter_log</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pct_retained =</span> <span class="fu">round</span>(n_after <span class="sc">/</span> n_start <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>))</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save filtering effects</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(filter_log, <span class="fu">file.path</span>(data_dir, <span class="st">"03_filtering_effects.csv"</span>))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Build filtered proteins list</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify which proteins were removed and why</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>all_uniprots <span class="ot">&lt;-</span> annot_df<span class="sc">$</span>uniprot_id</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>kept_uniprots <span class="ot">&lt;-</span> <span class="fu">rownames</span>(dal<span class="sc">$</span>data)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>removed_uniprots <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(all_uniprots, kept_uniprots)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>filtered_proteins <span class="ot">&lt;-</span> annot_df <span class="sc">%&gt;%</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(uniprot_id <span class="sc">%in%</span> removed_uniprots) <span class="sc">%&gt;%</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(uniprot_id, gene, description, in_hpa_muscle) <span class="sc">%&gt;%</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">reason =</span> <span class="fu">if_else</span>(<span class="sc">!</span>in_hpa_muscle, <span class="st">"Not in HPA muscle"</span>, <span class="st">"Missingness"</span>))</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(filtered_proteins, <span class="fu">file.path</span>(data_dir, <span class="st">"03_filtered_proteins.csv"</span>))</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(filter_log, <span class="at">caption =</span> <span class="st">"Protein filtering summary"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Protein filtering summary</caption>
<colgroup>
<col style="width: 50%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 12%">
<col style="width: 16%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">step</th>
<th style="text-align: right;">n_before</th>
<th style="text-align: right;">n_after</th>
<th style="text-align: right;">n_removed</th>
<th style="text-align: right;">pct_retained</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Raw input</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">3172</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">100.0</td>
</tr>
<tr class="even">
<td style="text-align: left;">HPA muscle tissue filter</td>
<td style="text-align: right;">3172</td>
<td style="text-align: right;">2962</td>
<td style="text-align: right;">210</td>
<td style="text-align: right;">93.4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Missingness filter (50% per Group_Time)</td>
<td style="text-align: right;">2962</td>
<td style="text-align: right;">1829</td>
<td style="text-align: right;">1133</td>
<td style="text-align: right;">57.7</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>A bar chart visualizes protein retention at each step, saved as a PDF for inclusion in downstream consolidated figures.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>filter_plot_data <span class="ot">&lt;-</span> filter_log <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">step =</span> <span class="fu">factor</span>(step, <span class="at">levels =</span> step))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>p_filter <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(filter_plot_data, <span class="fu">aes</span>(<span class="at">x =</span> step, <span class="at">y =</span> n_after)) <span class="sc">+</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">"#2166AC"</span>, <span class="at">width =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> n_after), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Number of proteins"</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Protein retention through filtering pipeline"</span>) <span class="sc">+</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">13</span>) <span class="sc">+</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">25</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>p_filter</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="CvH_normalization_files/figure-html/filtering-barplot-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Protein counts at each filtering stage</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-outliers" class="level1">
<h1>4 — Outlier Detection (Tiered Approach)</h1>
<p>Sample-level outliers can arise from technical failures (failed digestion, poor injection), sample degradation, or mislabeling. We apply three complementary diagnostic methods to flag problematic samples, then use a <strong>tiered strategy</strong> to decide which samples to remove versus retain with downweighting.</p>
<section id="detection-methods" class="level2">
<h2 class="anchored" data-anchor-id="detection-methods">Detection methods</h2>
<ol type="1">
<li><strong>Missingness rate</strong> — samples with missing-data percentage exceeding Q3 + 1.5 × IQR (Tukey fence), optionally combined with paired T1/T2 missingness deltas for CR subjects</li>
<li><strong>PCA Mahalanobis distance</strong> — multivariate outlier detection on PC1–3, flagged at χ²(0.99, df = 3) (Hubert et al., 2005)</li>
<li><strong>MAD-based median intensity</strong> — samples whose median log2 intensity deviates from the global median by &gt; 3 × MAD (Leys et al., 2013)</li>
</ol>
</section>
<section id="tiered-removal-strategy" class="level2">
<h2 class="anchored" data-anchor-id="tiered-removal-strategy">Tiered removal strategy</h2>
<p>Rather than removing all samples flagged by ≥2 methods, we adopt a <strong>graduated approach</strong> based on the limma literature:</p>
<ul>
<li><strong>Catastrophic</strong> (≥3 flags AND &gt;50% missing): Hard-remove. These represent failed runs where the majority of proteins are undetected; no statistical method can rescue meaningful signal from a sample missing 60%+ of its data.</li>
<li><strong>Soft outlier</strong> (≥2 flags, not catastrophic): Retain in the dataset. These are handled downstream by <code>arrayWeights()</code> (Ritchie et al., 2006), which assigns data-driven quality weights to each sample. A marginal sample receives a reduced weight proportional to its deviation, rather than being discarded entirely.</li>
<li><strong>Normal</strong> (&lt;2 flags): Full weight.</li>
</ul>
<p>This strategy is motivated by Gordon Smyth’s (limma developer) guidance: <em>“Arrays have to be very bad indeed before they contain no useful information. It is usually preferable to allow for some samples being less reliable than others in a graduated way rather than complete removal”</em> (Bioconductor support, Ritchie et al.&nbsp;2006). The <code>arrayWeights()</code> function estimates a log-linear variance model log(σ²<sub>gj</sub>) = δ<sub>g</sub> + γ<sub>j</sub> across all proteins, where γ<sub>j</sub> captures sample-specific quality. Samples with consistently large residuals receive lower weights w<sub>j</sub> = 1/exp(γ<sub>j</sub>), achieving data-driven downweighting without arbitrary thresholds (Ritchie et al., 2006; Liu et al., 2015).</p>
<p>For the DEP analysis (step 04), we additionally apply <code>eBayes(robust = TRUE)</code> (Phipson et al., 2016), which protects against hypervariable proteins distorting the empirical Bayes prior — a complementary layer of robustness operating at the protein level rather than the sample level.</p>
<p>These diagnostics are applied <strong>before normalization</strong> since they rely on missingness patterns and raw intensity structure rather than normalized values.</p>
<p>Flag samples with anomalously high missingness using IQR fences. For paired CR subjects, a large delta between T1 and T2 missingness may indicate a failed run at one timepoint.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Per-sample percent missing</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pct_missing <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(<span class="fu">is.na</span>(dal<span class="sc">$</span>data)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Paired missingness for CR subjects with both T1 and T2</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>paired_subjects <span class="ot">&lt;-</span> dal<span class="sc">$</span>metadata <span class="sc">%&gt;%</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Group <span class="sc">!=</span> <span class="st">"PPS"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(Subject_ID) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(Subject_ID)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Per-SUBJECT paired data: one row per subject with max missingness and |delta|</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>paired_data <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Subject_ID =</span> <span class="fu">character</span>(),</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_t1 =</span> <span class="fu">character</span>(),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">col_t2 =</span> <span class="fu">character</span>(),</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_miss =</span> <span class="fu">numeric</span>(),</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">abs_delta =</span> <span class="fu">numeric</span>()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (subj <span class="cf">in</span> paired_subjects) {</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>  rows <span class="ot">&lt;-</span> dal<span class="sc">$</span>metadata <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Subject_ID <span class="sc">==</span> subj)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>  t1_id <span class="ot">&lt;-</span> rows<span class="sc">$</span>Col_ID[rows<span class="sc">$</span>Timepoint <span class="sc">==</span> <span class="st">"T1"</span>]</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>  t2_id <span class="ot">&lt;-</span> rows<span class="sc">$</span>Col_ID[rows<span class="sc">$</span>Timepoint <span class="sc">==</span> <span class="st">"T2"</span>]</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(t1_id) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(t2_id) <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    m1 <span class="ot">&lt;-</span> pct_missing[t1_id]</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    m2 <span class="ot">&lt;-</span> pct_missing[t2_id]</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    paired_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(paired_data, <span class="fu">tibble</span>(</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">Subject_ID =</span> subj,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">col_t1 =</span> t1_id,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">col_t2 =</span> t2_id,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">max_miss =</span> <span class="fu">max</span>(m1, m2),</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">abs_delta =</span> <span class="fu">abs</span>(m2 <span class="sc">-</span> m1)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Map subject-level abs_delta back to per-sample rows for flagging</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>sample_miss <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">Col_ID =</span> <span class="fu">colnames</span>(dal<span class="sc">$</span>data),</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">pct_missing =</span> pct_missing[<span class="fu">colnames</span>(dal<span class="sc">$</span>data)]</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    dal<span class="sc">$</span>metadata <span class="sc">%&gt;%</span> <span class="fu">select</span>(Col_ID, Subject_ID),</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Col_ID"</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    paired_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(Subject_ID, abs_delta),</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"Subject_ID"</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># IQR-based thresholds</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>miss_q3  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pct_missing, <span class="fl">0.75</span>)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>miss_iqr <span class="ot">&lt;-</span> <span class="fu">IQR</span>(pct_missing)</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>miss_threshold <span class="ot">&lt;-</span> miss_q3 <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> miss_iqr</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>abs_delta_vals <span class="ot">&lt;-</span> paired_data<span class="sc">$</span>abs_delta</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(abs_delta_vals) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>  delta_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(abs_delta_vals, <span class="fl">0.75</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> <span class="fu">IQR</span>(abs_delta_vals)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  delta_threshold <span class="ot">&lt;-</span> <span class="cn">Inf</span></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>sample_miss <span class="ot">&lt;-</span> sample_miss <span class="sc">%&gt;%</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">miss_flag =</span> pct_missing <span class="sc">&gt;</span> miss_threshold <span class="sc">|</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>      (<span class="sc">!</span><span class="fu">is.na</span>(abs_delta) <span class="sc">&amp;</span> abs_delta <span class="sc">&gt;</span> delta_threshold)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>Multivariate outlier detection in PCA space catches samples that deviate in ways no single metric would flag (Hubert et al., 2005).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA on log2-transformed, median-imputed data</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>data_for_pca <span class="ot">&lt;-</span> dal<span class="sc">$</span>data</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute NAs with column medians (temporary — for PCA only)</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(data_for_pca))) {</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  nas <span class="ot">&lt;-</span> <span class="fu">is.na</span>(data_for_pca[, j])</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(nas)) {</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    data_for_pca[nas, j] <span class="ot">&lt;-</span> <span class="fu">median</span>(data_for_pca[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co"># No +1 pseudocount needed: zeros already converted to NA by zero_to_missing(),</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co"># and NAs filled by column medians above. All values are positive observed intensities.</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>data_log2 <span class="ot">&lt;-</span> <span class="fu">log2</span>(data_for_pca)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>pca_res <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">t</span>(data_log2), <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>pc_scores <span class="ot">&lt;-</span> pca_res<span class="sc">$</span>x[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Mahalanobis distance</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>center <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(pc_scores)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>cov_mat <span class="ot">&lt;-</span> <span class="fu">cov</span>(pc_scores)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>mahal_dist <span class="ot">&lt;-</span> <span class="fu">mahalanobis</span>(pc_scores, center, cov_mat)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Chi-squared threshold (p &lt; 0.01, df = 3)</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>mahal_threshold <span class="ot">&lt;-</span> <span class="fu">qchisq</span>(<span class="fl">0.99</span>, <span class="at">df =</span> <span class="dv">3</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>pca_flags <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Col_ID =</span> <span class="fu">colnames</span>(dal<span class="sc">$</span>data),</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">mahal_dist =</span> mahal_dist,</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">pca_flag =</span> mahal_dist <span class="sc">&gt;</span> mahal_threshold</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>MAD-based intensity screening catches global intensity shifts (e.g., loading errors) that PCA may miss (Leys et al., 2013).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Per-sample median log2 intensity</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sample_medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">log2</span>(dal<span class="sc">$</span>data), <span class="dv">2</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>global_median  <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_medians)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>mad_val        <span class="ot">&lt;-</span> <span class="fu">mad</span>(sample_medians)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>mad_flags <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Col_ID =</span> <span class="fu">names</span>(sample_medians),</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_median =</span> sample_medians,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">mad_deviation =</span> <span class="fu">abs</span>(sample_medians <span class="sc">-</span> global_median),</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">mad_flag =</span> <span class="fu">abs</span>(sample_medians <span class="sc">-</span> global_median) <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">*</span> mad_val</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p>The three binary flags are combined into a <strong>tiered consensus</strong>. Rather than removing all samples with ≥2 flags, we classify each sample into one of three tiers using <code>case_when()</code>:</p>
<ul>
<li><strong>catastrophic</strong>: ≥3 flags AND &gt;50% missingness — unambiguous technical failure, hard-removed</li>
<li><strong>soft_outlier</strong>: ≥2 flags but not catastrophic — retained, handled by <code>arrayWeights()</code> downstream (Ritchie et al., 2006)</li>
<li><strong>normal</strong>: &lt;2 flags — no action needed</li>
</ul>
<p>This tiered approach preserves marginal samples that still contain useful biological signal while removing only those that are truly unrescuable. The <code>arrayWeights()</code> function in the DEP step will assign data-driven quality weights to each sample, effectively downweighting soft outliers in proportion to their deviation without discarding their information entirely.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all flags into tiered classification</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>outlier_diag <span class="ot">&lt;-</span> sample_miss <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Col_ID, pct_missing, abs_delta, miss_flag) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pca_flags, <span class="at">by =</span> <span class="st">"Col_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(mad_flags, <span class="at">by =</span> <span class="st">"Col_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_flags =</span> miss_flag <span class="sc">+</span> pca_flag <span class="sc">+</span> mad_flag,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">tier =</span> <span class="fu">case_when</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>      n_flags <span class="sc">&gt;=</span> <span class="dv">3</span> <span class="sc">&amp;</span> pct_missing <span class="sc">&gt;</span> <span class="dv">50</span> <span class="sc">~</span> <span class="st">"catastrophic"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>      n_flags <span class="sc">&gt;=</span> <span class="dv">2</span>                     <span class="sc">~</span> <span class="st">"soft_outlier"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span>                             <span class="sc">~</span> <span class="st">"normal"</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(outlier_diag, <span class="fu">file.path</span>(data_dir, <span class="st">"04_outlier_diagnostics.csv"</span>))</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>n_catastrophic  <span class="ot">&lt;-</span> <span class="fu">sum</span>(outlier_diag<span class="sc">$</span>tier <span class="sc">==</span> <span class="st">"catastrophic"</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>n_soft          <span class="ot">&lt;-</span> <span class="fu">sum</span>(outlier_diag<span class="sc">$</span>tier <span class="sc">==</span> <span class="st">"soft_outlier"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Tiered outlier results: %d catastrophic (remove), %d soft (arrayWeights)</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>            n_catastrophic, n_soft))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Tiered outlier results: 1 catastrophic (remove), 2 soft (arrayWeights)</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (n_catastrophic <span class="sc">+</span> n_soft <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  outlier_diag <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tier <span class="sc">!=</span> <span class="st">"normal"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(Col_ID, pct_missing, abs_delta, mahal_dist, n_flags, tier) <span class="sc">%&gt;%</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kable</span>(<span class="at">caption =</span> <span class="st">"Flagged samples: catastrophic = remove, soft_outlier = retain with arrayWeights"</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Flagged samples: catastrophic = remove, soft_outlier = retain with arrayWeights</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Col_ID</th>
<th style="text-align: right;">pct_missing</th>
<th style="text-align: right;">abs_delta</th>
<th style="text-align: right;">mahal_dist</th>
<th style="text-align: right;">n_flags</th>
<th style="text-align: left;">tier</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">CR10_T1</td>
<td style="text-align: right;">26.79060</td>
<td style="text-align: right;">25.31438</td>
<td style="text-align: right;">15.038669</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">soft_outlier</td>
</tr>
<tr class="even">
<td style="text-align: left;">CR386_T1</td>
<td style="text-align: right;">20.33898</td>
<td style="text-align: right;">16.56643</td>
<td style="text-align: right;">7.005708</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">soft_outlier</td>
</tr>
<tr class="odd">
<td style="text-align: left;">CR9_T1</td>
<td style="text-align: right;">60.08748</td>
<td style="text-align: right;">49.91799</td>
<td style="text-align: right;">32.895561</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">catastrophic</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Three diagnostic panels visualize each outlier method, colored by tier: <strong>red</strong> = catastrophic (hard-removed), <strong>orange</strong> = soft outlier (retained for <code>arrayWeights</code>), <strong>gray</strong> = normal. Dashed lines show detection thresholds for each method. (A) paired missingness — one point per subject, x = max missingness of the pair, y = |delta| — with IQR fence, (B) PCA biplot with Mahalanobis threshold, (C) per-sample median intensity with ±3 MAD bounds. All points are labeled with sample/subject identifiers.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>tier_colors <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">catastrophic =</span> <span class="st">"#B2182B"</span>, <span class="at">soft_outlier =</span> <span class="st">"#F4A582"</span>, <span class="at">normal =</span> <span class="st">"gray50"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 1: Paired missingness — one point per SUBJECT</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine subject-level tier (worst tier of the pair)</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>subject_tier <span class="ot">&lt;-</span> outlier_diag <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dal<span class="sc">$</span>metadata <span class="sc">%&gt;%</span> <span class="fu">select</span>(Col_ID, Subject_ID), <span class="at">by =</span> <span class="st">"Col_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tier_rank =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    tier <span class="sc">==</span> <span class="st">"catastrophic"</span> <span class="sc">~</span> <span class="dv">3</span>L,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    tier <span class="sc">==</span> <span class="st">"soft_outlier"</span> <span class="sc">~</span> <span class="dv">2</span>L,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">1</span>L</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Subject_ID) <span class="sc">%&gt;%</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">tier_rank =</span> <span class="fu">max</span>(tier_rank), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tier =</span> <span class="fu">case_when</span>(</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    tier_rank <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"catastrophic"</span>,</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    tier_rank <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"soft_outlier"</span>,</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"normal"</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>paired_plot_data <span class="ot">&lt;-</span> paired_data <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(subject_tier <span class="sc">%&gt;%</span> <span class="fu">select</span>(Subject_ID, tier), <span class="at">by =</span> <span class="st">"Subject_ID"</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(paired_plot_data, <span class="fu">aes</span>(<span class="at">x =</span> max_miss, <span class="at">y =</span> abs_delta)) <span class="sc">+</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> tier), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> Subject_ID, <span class="at">color =</span> tier),</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">2.8</span>, <span class="at">max.overlaps =</span> <span class="dv">30</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> delta_threshold,</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> miss_threshold,</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> tier_colors) <span class="sc">+</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Max % Missing (worst of T1/T2)"</span>,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"|Delta Missing| (|T2 - T1|)"</span>,</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"A: Paired Missingness (one point per subject)"</span>,</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Tier"</span>) <span class="sc">+</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>)</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 2: PCA with Mahalanobis — labeled with Col_ID</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>pc_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pca_res<span class="sc">$</span>x[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>pc_df<span class="sc">$</span>Col_ID <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pc_df)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>pc_df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pc_df, outlier_diag <span class="sc">%&gt;%</span> <span class="fu">select</span>(Col_ID, tier), <span class="at">by =</span> <span class="st">"Col_ID"</span>)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>var_explained <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">summary</span>(pca_res)<span class="sc">$</span>importance[<span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pc_df, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2)) <span class="sc">+</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> tier), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> Col_ID, <span class="at">color =</span> tier),</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="fl">2.3</span>, <span class="at">max.overlaps =</span> <span class="dv">50</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> tier_colors) <span class="sc">+</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">sprintf</span>(<span class="st">"PC1 (%.1f%%)"</span>, var_explained[<span class="dv">1</span>]),</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">sprintf</span>(<span class="st">"PC2 (%.1f%%)"</span>, var_explained[<span class="dv">2</span>]),</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"B: PCA Outliers (Mahalanobis)"</span>, <span class="at">color =</span> <span class="st">"Tier"</span>) <span class="sc">+</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>)</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel 3: MAD — Col_ID on x-axis + labeled points</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(outlier_diag, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Col_ID, sample_median), <span class="at">y =</span> sample_median)) <span class="sc">+</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color =</span> tier), <span class="at">size =</span> <span class="fl">2.5</span>) <span class="sc">+</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> global_median, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> global_median <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="dv">3</span>) <span class="sc">*</span> mad_val,</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>             <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> tier_colors) <span class="sc">+</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Sample (ordered by median intensity)"</span>, <span class="at">y =</span> <span class="st">"Median log2 intensity"</span>,</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"C: MAD Intensity Outliers"</span>, <span class="at">color =</span> <span class="st">"Tier"</span>) <span class="sc">+</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>p_outlier <span class="ot">&lt;-</span> p1 <span class="sc">+</span> p2 <span class="sc">+</span> p3 <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>p_outlier</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="CvH_normalization_files/figure-html/outlier-plots-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Outlier diagnostic panels — colored by tier (red = catastrophic, orange = soft outlier)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sample-removal" class="level2">
<h2 class="anchored" data-anchor-id="sample-removal">Sample removal</h2>
<p>Only <strong>catastrophic</strong> samples are hard-removed via <code>filter_samples()</code>. Soft outliers are retained — their reduced quality will be accounted for by <code>arrayWeights()</code> (Ritchie et al., 2006) during the DEP analysis in step 04.</p>
<p><code>arrayWeights()</code> works by fitting a log-linear variance model across all proteins, estimating a sample-specific quality factor γ<sub>j</sub>. Samples with consistently large residuals receive lower weights w<sub>j</sub> = 1/exp(γ<sub>j</sub>). This data-driven approach is superior to binary removal because:</p>
<ol type="1">
<li>It preserves sample size and degrees of freedom</li>
<li>The weight is proportional to actual data quality, not a threshold</li>
<li>It avoids creating unbalanced paired designs (orphaned T2 timepoints)</li>
<li><code>duplicateCorrelation()</code> handles unbalanced designs correctly (Smyth, Bioconductor support p/125328): <em>“It reduces the influence of subjects with more biopsies vs those with fewer”</em></li>
</ol>
<p>For paired designs where one timepoint is a soft outlier, <code>arrayWeights</code> assigns the problematic timepoint a reduced weight while the good timepoint receives a normal weight. The subject still contributes to the analysis proportionally to its data quality (Liu et al., 2015).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (n_catastrophic <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  catastrophic_ids <span class="ot">&lt;-</span> outlier_diag <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(tier <span class="sc">==</span> <span class="st">"catastrophic"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(Col_ID)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Hard-removing %d catastrophic sample(s): %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>              <span class="fu">length</span>(catastrophic_ids), <span class="fu">paste</span>(catastrophic_ids, <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>  dal <span class="ot">&lt;-</span> <span class="fu">filter_samples</span>(dal, <span class="sc">!</span>(Col_ID <span class="sc">%in%</span> catastrophic_ids))</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"After removal: %d samples remain</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">ncol</span>(dal<span class="sc">$</span>data)))</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No catastrophic outliers — no samples removed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Hard-removing 1 catastrophic sample(s): CR9_T1</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>After removal: 40 samples remain</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (n_soft <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  soft_ids <span class="ot">&lt;-</span> outlier_diag <span class="sc">%&gt;%</span> <span class="fu">filter</span>(tier <span class="sc">==</span> <span class="st">"soft_outlier"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(Col_ID)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Soft outlier(s) retained for arrayWeights: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>              <span class="fu">paste</span>(soft_ids, <span class="at">collapse =</span> <span class="st">", "</span>)))</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Soft outlier(s) retained for arrayWeights: CR10_T1, CR386_T1</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-normalization" class="level1">
<h1>5 — Normalization</h1>
<p>Normalization corrects for systematic technical variation (e.g., sample loading differences, LC-MS run effects) while preserving biological differences. We use the <code>proteoDA</code> normalization report to visually compare eight available methods, then apply cyclic loess (<code>cycloess</code>) normalization.</p>
<p>Cyclic loess was recommended by Välikangas et al.&nbsp;(2018) as one of the best-performing methods for label-free quantitative proteomics data, particularly with small sample sizes. It applies a series of pairwise loess regressions between all sample pairs, iteratively adjusting intensity distributions without assuming equal protein loading across conditions — an important property for tissues with potentially different total protein composition (e.g., cancer survivor vs.&nbsp;healthy muscle).</p>
<p>Review the normalization report to confirm cycloess is appropriate before applying it. The report compares eight methods side by side.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_norm_report</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  dal,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">grouping_column =</span> <span class="st">"Group_Time"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> report_dir,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"01_normalization_report.pdf"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Normalization report saved to b_reports/01_normalization_report.pdf</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Normalization report saved to b_reports/01_normalization_report.pdf</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Review this report to confirm cycloess is appropriate for this dataset.</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Review this report to confirm cycloess is appropriate for this dataset.</code></pre>
</div>
</div>
<p>Generate a pre-normalization QC report to serve as the baseline for comparison with the post-normalization QC report. Differences between the two reveal the effect of cycloess correction on sample clustering, correlation structure, and intensity distributions.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_qc_report</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  dal,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">color_column =</span> <span class="st">"Group_Time"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_column =</span> <span class="st">"Col_ID"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> report_dir,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"02_qc_report_pre_norm.pdf"</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Pre-normalization QC report saved to b_reports/02_qc_report_pre_norm.pdf</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Pre-normalization QC report saved to b_reports/02_qc_report_pre_norm.pdf</code></pre>
</div>
</div>
<p>Apply cycloess normalization. Unlike quantile normalization, cyclic loess does not assume equal total protein loading across conditions — important when comparing cancer survivor and healthy muscle tissue (Välikangas et al., 2018; Karpievitch et al., 2012).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dal <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(dal, <span class="at">norm_method =</span> <span class="st">"cycloess"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Normalization complete (cycloess): %d proteins x %d samples</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(dal<span class="sc">$</span>data), <span class="fu">ncol</span>(dal<span class="sc">$</span>data)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Normalization complete (cycloess): 1829 proteins x 40 samples</code></pre>
</div>
</div>
</section>
<section id="sec-qc" class="level1">
<h1>6 — Post-Normalization QC</h1>
<p>After normalization, we generate a quality control report to assess sample clustering, correlation structure, and the distribution of normalized intensities. The PCA and hierarchical clustering should show samples grouping primarily by biological condition (<code>Group_Time</code>) rather than technical factors.</p>
<p>After normalization, samples should cluster by biology (<code>Group_Time</code>) rather than by technical factors. The QC report checks this via correlation heatmap, clustering dendrogram, and PCA.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write_qc_report</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  dal,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">color_column =</span> <span class="st">"Group_Time"</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_column =</span> <span class="st">"Col_ID"</span>,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_dir =</span> report_dir,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"03_qc_report_post_norm.pdf"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Post-normalization QC report saved to b_reports/03_qc_report_post_norm.pdf</span><span class="sc">\n</span><span class="st">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Post-normalization QC report saved to b_reports/03_qc_report_post_norm.pdf</code></pre>
</div>
</div>
<p>A custom PCA supplements the standard QC report, colored by biological group: CR_T1 (all cancer survivors at baseline, pooling CRE and PLA), CR_T2 (post-training), and PPS_T1 (healthy controls). This three-group view reflects the study’s primary biological comparison.</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA on normalized data</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>norm_mat <span class="ot">&lt;-</span> dal<span class="sc">$</span>data</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Impute remaining NAs with column medians for PCA</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(norm_mat))) {</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  nas <span class="ot">&lt;-</span> <span class="fu">is.na</span>(norm_mat[, j])</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(nas)) {</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    norm_mat[nas, j] <span class="ot">&lt;-</span> <span class="fu">median</span>(norm_mat[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>pca_norm <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(<span class="fu">t</span>(norm_mat), <span class="at">center =</span> <span class="cn">TRUE</span>, <span class="at">scale. =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>pc_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(pca_norm<span class="sc">$</span>x[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>])</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>pc_df<span class="sc">$</span>Col_ID <span class="ot">&lt;-</span> <span class="fu">rownames</span>(pc_df)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>pc_df <span class="ot">&lt;-</span> <span class="fu">left_join</span>(pc_df, dal<span class="sc">$</span>metadata, <span class="at">by =</span> <span class="st">"Col_ID"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BioGroup =</span> <span class="fu">case_when</span>(</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    Group_Time <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CRE_T1"</span>, <span class="st">"PLA_T1"</span>) <span class="sc">~</span> <span class="st">"CR_T1"</span>,</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    Group_Time <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CRE_T2"</span>, <span class="st">"PLA_T2"</span>) <span class="sc">~</span> <span class="st">"CR_T2"</span>,</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"PPS_T1"</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>var_exp <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">summary</span>(pca_norm)<span class="sc">$</span>importance[<span class="dv">2</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>pal_bio <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">CR_T1 =</span> <span class="st">"#4393C3"</span>, <span class="at">CR_T2 =</span> <span class="st">"#2166AC"</span>, <span class="at">PPS_T1 =</span> <span class="st">"#B2182B"</span>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>p_pca <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pc_df, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> BioGroup)) <span class="sc">+</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">alpha =</span> <span class="fl">0.85</span>) <span class="sc">+</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="fu">aes</span>(<span class="at">group =</span> BioGroup), <span class="at">type =</span> <span class="st">"norm"</span>, <span class="at">level =</span> <span class="fl">0.68</span>,</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>               <span class="at">linetype =</span> <span class="st">"solid"</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="fu">aes</span>(<span class="at">label =</span> Col_ID), <span class="at">size =</span> <span class="fl">2.3</span>, <span class="at">max.overlaps =</span> <span class="dv">50</span>,</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>                  <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> pal_bio) <span class="sc">+</span></span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="fu">sprintf</span>(<span class="st">"PC1 (%.1f%%)"</span>, var_exp[<span class="dv">1</span>]),</span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">sprintf</span>(<span class="st">"PC2 (%.1f%%)"</span>, var_exp[<span class="dv">2</span>]),</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Post-normalization PCA"</span>,</span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>p_pca</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="CvH_normalization_files/figure-html/custom-pca-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Post-normalization PCA — CvH dataset (CR_T1 / CR_T2 / PPS_T1)</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-export" class="level1">
<h1>7 — Export</h1>
<p>We export the normalized dataset in two formats: a flat CSV for interoperability with other tools, and an <code>.rds</code> file preserving the full <code>DAList</code> object for seamless continuation into the modeling phase.</p>
<p>Export both a flat CSV (for interoperability with external tools) and the full DAList object (for seamless continuation into downstream stages).</p>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CSV: annotation (including n_seq for downstream peptide counts) + normalized intensities</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>export_df <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(dal<span class="sc">$</span>annotation) <span class="sc">%&gt;%</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(uniprot_id, protein, gene, description, n_seq),</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(dal<span class="sc">$</span>data)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(export_df, <span class="fu">file.path</span>(data_dir, <span class="st">"01_normalized.csv"</span>))</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a><span class="co"># RDS: full DAList</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dal, <span class="fu">file.path</span>(data_dir, <span class="st">"01_DAList_normalized.rds"</span>))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Exported: %d proteins x %d samples</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nrow</span>(dal<span class="sc">$</span>data), <span class="fu">ncol</span>(dal<span class="sc">$</span>data)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Exported: 1829 proteins x 40 samples</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  CSV: %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">file.path</span>(data_dir, <span class="st">"01_normalized.csv"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  CSV: /Users/dtl0018/Desktop/A_Proteomics_Analysis/A_CvH_2026/01_normalization/c_data/01_normalized.csv</code></pre>
</div>
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"  RDS: %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">file.path</span>(data_dir, <span class="st">"01_DAList_normalized.rds"</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>  RDS: /Users/dtl0018/Desktop/A_Proteomics_Analysis/A_CvH_2026/01_normalization/c_data/01_DAList_normalized.rds</code></pre>
</div>
</div>
</section>
<section id="sec-downstream" class="level1">
<h1>8 — Downstream Preview</h1>
<p>The normalized <code>DAList</code> feeds into three subsequent stages, each with its own script and narrative QMD:</p>
<ul>
<li><strong>02_Imputation</strong>: MAR/MNAR classification, benchmark of 14 methods, quality audit</li>
<li><strong>03_Sensitivity_check</strong>: 12-pipeline grid (3 norms × 4 imps) confirming robustness</li>
<li><strong>04_DEP</strong>: Differential expression via limma with arrayWeights, duplicateCorrelation, and eBayes(robust=TRUE)</li>
</ul>
</section>
<section id="sec-refs" class="level1">
<h1>References</h1>
<ol type="1">
<li><p>Välikangas T, Suomi T, Elo LL (2018). A systematic evaluation of normalization methods in quantitative label-free proteomics. <em>Briefings in Bioinformatics</em> 19(1):1-11.</p></li>
<li><p>Ritchie ME, Phipson B, Wu D, et al.&nbsp;(2015). limma powers differential expression analyses for RNA-sequencing and microarray studies. <em>Nucleic Acids Research</em> 43(7):e47.</p></li>
<li><p>Lazar C, Gatto L, Ferro M, et al.&nbsp;(2016). Accounting for the multiple natures of missing values in label-free quantitative proteomics data sets to compare imputation strategies. <em>Journal of Proteome Research</em> 15(4):1116-1125.</p></li>
<li><p>Webb-Robertson BM, Wiber HK, Matzke MM, et al.&nbsp;(2015). Review, evaluation, and discussion of the challenges of missing value imputation for mass spectrometry-based label-free global proteomics. <em>Journal of Proteome Research</em> 14(3):920-930.</p></li>
<li><p>Herbrich SM, Cole RN, West KP Jr, et al.&nbsp;(2013). Statistical inference from multiple iTRAQ experiments without using common reference standards. <em>Journal of Proteome Research</em> 12(2):594-604.</p></li>
<li><p>Phipson B, Lee S, Oshlack A, et al.&nbsp;(2016). Robust hyperparameter estimation protects against hypervariable genes and improves power to detect differential expression. <em>Annals of Applied Statistics</em> 10(2):946-963.</p></li>
<li><p>Hubert M, Rousseeuw PJ, Vanden Branden K (2005). ROBPCA: A new approach to robust principal component analysis. <em>Technometrics</em> 47(1):64-79.</p></li>
<li><p>Leys C, Ley C, Klein O, et al.&nbsp;(2013). Detecting outliers: Do not use standard deviation around the mean, use absolute deviation around the median. <em>Journal of Experimental Social Psychology</em> 49(4):764-766.</p></li>
<li><p>Karpievitch YV, Dabney AR, Smith RD (2012). Normalization and missing value imputation for label-free LC-MS analysis. <em>BMC Bioinformatics</em> 13(Suppl 16):S5.</p></li>
<li><p>O’Brien JJ, Bhatt DK, Engel JM, et al.&nbsp;(2018). Label-free quantitative proteomics analysis of mass spectrometry data with implications for missingness and filtering strategies. <em>Annals of Applied Statistics</em> 12(4):2484-2510. PMID:30473739.</p></li>
<li><p>Arioli A, Dagliati A, Geary B, et al.&nbsp;(2021). OptiMissP: A dashboard to assess missingness in proteomic data-independent acquisition mass spectrometry. <em>PLoS One</em> 16(4):e0249771. PMID:33857200.</p></li>
<li><p>McGurk KA, Dagliati A, Chiasserini D, et al.&nbsp;(2020). The use of missing values in proteomic data-independent acquisition mass spectrometry to enable disease activity discrimination. <em>Bioinformatics</em> 36(7):2217-2223. PMID:31790148.</p></li>
<li><p>Dabke K, Hendrick G, Devkota S (2021). The gut microbiome and metabolic syndrome — proteomics quality-filtering benchmarks. <em>Journal of Proteome Research</em> 20(6):3214-3229. PMID:33939434.</p></li>
<li><p>Kong W, Hui HWH, Peng H, et al.&nbsp;(2022). Dealing with missing values in proteomics data. <em>Proteomics</em> 23(23-24):e2200092. PMID:36349819.</p></li>
<li><p>Harris L, Fondrie WE, Oh S, Noble WS (2023). Evaluating proteomics imputation methods with improved criteria. <em>Journal of Proteome Research</em> 22(11):3427-3438. PMID:37861703.</p></li>
<li><p>Uhlen M, Fagerberg L, Hallstrom BM, et al.&nbsp;(2015). Tissue-based map of the human proteome. <em>Science</em> 347(6220):1260419. PMID:25613900.</p></li>
<li><p>Ritchie ME, Diyagama D, Neilson J, et al.&nbsp;(2006). Empirical array quality weights in the analysis of microarray data. <em>BMC Bioinformatics</em> 7:261. PMID:16712727.</p></li>
<li><p>Liu R, Holik AZ, Su S, et al.&nbsp;(2015). Why weight? Modelling sample and observational level variability improves power in RNA-seq analyses. <em>Nucleic Acids Research</em> 43(15):e97. PMID:25925576.</p></li>
</ol>
</section>
<section id="sec-session" class="level1">
<h1>Session Info</h1>
<div class="cell">
<details class="code-fold">
<summary>Show code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.1 (2025-06-13)
Platform: aarch64-apple-darwin20
Running under: macOS Tahoe 26.2

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] here_1.0.2      knitr_1.51      ggrepel_0.9.6   patchwork_1.3.2
 [5] ggplot2_4.0.2   stringr_1.6.0   tidyr_1.3.2     dplyr_1.2.0    
 [9] readr_2.1.6     readxl_1.4.5    proteoDA_1.0.1 

loaded via a namespace (and not attached):
 [1] gridExtra_2.3         rlang_1.1.7           magrittr_2.0.4       
 [4] clue_0.3-66           GetoptLong_1.1.0      otel_0.2.0           
 [7] matrixStats_1.5.0     compiler_4.5.1        mgcv_1.9-4           
[10] png_0.1-8             systemfonts_1.3.1     vctrs_0.7.1          
[13] shape_1.4.6.1         pkgconfig_2.0.3       crayon_1.5.3         
[16] fastmap_1.2.0         magick_2.9.0          labeling_0.4.3       
[19] rmarkdown_2.30        tzdb_0.5.0            preprocessCore_1.72.0
[22] ragg_1.5.0            purrr_1.2.1           bit_4.6.0            
[25] xfun_0.56             aplot_0.2.9           jsonlite_2.0.0       
[28] cluster_2.1.8.2       parallel_4.5.1        R6_2.6.1             
[31] stringi_1.8.7         RColorBrewer_1.1-3    limma_3.66.0         
[34] cellranger_1.1.0      Rcpp_1.1.1            iterators_1.0.14     
[37] pacman_0.5.1          IRanges_2.44.0        Matrix_1.7-4         
[40] splines_4.5.1         tidyselect_1.2.1      yaml_2.3.12          
[43] doParallel_1.0.17     codetools_0.2-20      affy_1.88.0          
[46] lattice_0.22-9        tibble_3.3.1          Biobase_2.70.0       
[49] treeio_1.32.0         withr_3.0.2           S7_0.2.1             
[52] evaluate_1.0.5        gridGraphics_0.5-1    circlize_0.4.17      
[55] pillar_1.11.1         affyio_1.80.0         BiocManager_1.30.27  
[58] ggtree_3.16.3         foreach_1.5.2         stats4_4.5.1         
[61] ggfun_0.2.0           generics_0.1.4        vroom_1.7.0          
[64] rprojroot_2.1.1       hms_1.1.4             S4Vectors_0.48.0     
[67] scales_1.4.0          tidytree_0.4.7        glue_1.8.0           
[70] lazyeval_0.2.2        tools_4.5.1           vsn_3.78.0           
[73] fs_1.6.6              grid_4.5.1            ape_5.8-1            
[76] colorspace_2.1-2      nlme_3.1-168          cli_3.6.5            
[79] rappdirs_0.3.4        textshaping_1.0.4     ComplexHeatmap_2.24.1
[82] gtable_0.3.6          yulab.utils_0.2.4     digest_0.6.39        
[85] BiocGenerics_0.56.0   ggplotify_0.1.3       rjson_0.2.23         
[88] htmlwidgets_1.6.4     farver_2.1.2          htmltools_0.5.9      
[91] lifecycle_1.0.5       GlobalOptions_0.1.3   statmod_1.5.1        
[94] bit64_4.6.0-1         MASS_7.3-65          </code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>